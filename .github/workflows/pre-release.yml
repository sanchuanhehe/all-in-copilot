name: Pre-release

on:
  push:
    branches:
      - 'pre-release/**'
      - 'beta/**'
      - 'alpha/**'
  workflow_dispatch:
    inputs:
      template:
        description: 'Template to pre-release (or "all" for all templates)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - glm-template
          - minimax-template
          - kimi-template
          - mimo-template
      bump_type:
        description: 'Version bump type for pre-release'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - patch
          - minor
          - major

jobs:
  build-sdk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install
      - run: pnpm --filter @all-in-copilot/sdk build

      - name: Upload SDK dist
        uses: actions/upload-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist

  determine-templates:
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.set-templates.outputs.templates }}
    steps:
      - name: Determine templates to build
        id: set-templates
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Branch-based pre-release - extract template from branch name
            BRANCH="${{ github.ref_name }}"
            # Format: pre-release/template-name or beta/template-name
            TEMPLATE="${BRANCH#*/}"
            if [[ "$TEMPLATE" == "all" ]] || [[ -z "$TEMPLATE" ]] || [[ "$TEMPLATE" == "$BRANCH" ]]; then
              echo 'templates=["glm-template","minimax-template","kimi-template","mimo-template"]' >> $GITHUB_OUTPUT
            else
              echo "templates=[\"$TEMPLATE\"]" >> $GITHUB_OUTPUT
            fi
          else
            # Manual dispatch
            if [[ "${{ inputs.template }}" == "all" ]]; then
              echo 'templates=["glm-template","minimax-template","kimi-template","mimo-template"]' >> $GITHUB_OUTPUT
            else
              echo "templates=[\"${{ inputs.template }}\"]" >> $GITHUB_OUTPUT
            fi
          fi

  package-and-publish:
    runs-on: ubuntu-latest
    needs: [build-sdk, determine-templates]
    strategy:
      matrix:
        template: ${{ fromJson(needs.determine-templates.outputs.templates) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Download SDK dist
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist

      - run: pnpm install

      - name: Get package info
        id: pkg
        run: |
          cd templates/${{ matrix.template }}
          NAME=$(node -p "require('./package.json').name")
          VERSION=$(node -p "require('./package.json').version")
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Package VSIX (Pre-release)
        run: |
          cd templates/${{ matrix.template }}
          npx @vscode/vsce package --no-dependencies --pre-release -o ${{ steps.pkg.outputs.name }}-${{ steps.pkg.outputs.version }}-pre.vsix

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.template }}-pre-vsix
          path: templates/${{ matrix.template }}/*.vsix

      - name: Publish Pre-release to VS Code Marketplace
        run: |
          cd templates/${{ matrix.template }}
          VSIX_FILE=$(ls *.vsix | head -n 1)
          echo "Publishing pre-release: $VSIX_FILE"
          npx @vscode/vsce publish --pat ${{ secrets.VSCE_PAT }} --packagePath "$VSIX_FILE" --pre-release
