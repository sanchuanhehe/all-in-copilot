name: Release Extensions

on:
  workflow_dispatch:
    inputs:
      template:
        description: 'Template to release (or "all" for all templates, use "sdk" for SDK package)'
        required: true
        default: "all"
        type: choice
        options:
          - sdk
          - all
          - acp-template
          - base-template
          - glm-template
          - minimax-template
          - kimi-template
          - kimi-coding-template
          - mimo-template
      pre_release:
        description: "Pre-release version"
        required: false
        default: false
        type: boolean
  push:
    tags:
      - "sdk-v*"
      - "acp-v*"
      - "base-v*"
      - "glm-v*"
      - "minimax-v*"
      - "kimi-v*"
      - "kimi-coding-v*"
      - "mimo-v*"
      - "v*"
      - "*-v*"

env:
  TEMPLATES: acp-template base-template glm-template minimax-template kimi-template kimi-coding-template mimo-template

jobs:
  build-sdk:
    if: ${{ needs.determine-templates.outputs.requires_sdk_build == 'true' }}
    needs: [determine-templates]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - run: pnpm install
      - run: pnpm --filter @all-in-copilot/sdk build

      - name: Upload SDK dist
        uses: actions/upload-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist

  determine-templates:
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.set-templates.outputs.templates }}
      component: ${{ steps.set-templates.outputs.component }}
      requires_sdk_build: ${{ steps.set-templates.outputs.requires_sdk_build }}
      pre_release: ${{ steps.set-release-type.outputs.pre_release }}
    steps:
      - name: Determine templates to build
        id: set-templates
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Tag-based release
            TAG="${{ github.ref_name }}"
            if [[ "$TAG" == sdk-v* ]]; then
              echo 'component=sdk' >> $GITHUB_OUTPUT
              echo 'templates=[]' >> $GITHUB_OUTPUT
              echo 'requires_sdk_build=true' >> $GITHUB_OUTPUT
            elif [[ "$TAG" == v* ]]; then
              # Global tag like v1.0.0 - build all
              echo 'component=templates' >> $GITHUB_OUTPUT
              echo 'templates=["acp-template","base-template","glm-template","minimax-template","kimi-template","kimi-coding-template","mimo-template"]' >> $GITHUB_OUTPUT
              echo 'requires_sdk_build=true' >> $GITHUB_OUTPUT
            else
              # Template-specific tags:
              # - New short tags: minimax-v1.2.3
              # - Legacy tags: minimax-template-v1.2.3
              BASE_TEMPLATE="${TAG%-v*}"
              case "$BASE_TEMPLATE" in
                acp) TEMPLATE="acp-template" ;;
                base) TEMPLATE="base-template" ;;
                glm) TEMPLATE="glm-template" ;;
                minimax) TEMPLATE="minimax-template" ;;
                kimi) TEMPLATE="kimi-template" ;;
                kimi-coding) TEMPLATE="kimi-coding-template" ;;
                mimo) TEMPLATE="mimo-template" ;;
                acp-template|base-template|glm-template|minimax-template|kimi-template|kimi-coding-template|mimo-template)
                  TEMPLATE="$BASE_TEMPLATE"
                  ;;
                *)
                  echo "Unsupported release tag: $TAG"
                  exit 1
                  ;;
              esac
              echo 'component=templates' >> $GITHUB_OUTPUT
              echo "templates=[\"$TEMPLATE\"]" >> $GITHUB_OUTPUT
              echo 'requires_sdk_build=true' >> $GITHUB_OUTPUT
            fi
          else
            # Manual dispatch
            if [[ "${{ inputs.template }}" == "sdk" ]]; then
              echo 'component=sdk' >> $GITHUB_OUTPUT
              echo 'templates=[]' >> $GITHUB_OUTPUT
              echo 'requires_sdk_build=true' >> $GITHUB_OUTPUT
            elif [[ "${{ inputs.template }}" == "all" ]]; then
              echo 'component=templates' >> $GITHUB_OUTPUT
              echo 'templates=["acp-template","base-template","glm-template","minimax-template","kimi-template","kimi-coding-template","mimo-template"]' >> $GITHUB_OUTPUT
              echo 'requires_sdk_build=true' >> $GITHUB_OUTPUT
            else
              echo 'component=templates' >> $GITHUB_OUTPUT
              echo "templates=[\"${{ inputs.template }}\"]" >> $GITHUB_OUTPUT
              echo 'requires_sdk_build=true' >> $GITHUB_OUTPUT
            fi
          fi

      - name: Determine release type
        id: set-release-type
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG="${{ github.ref_name }}"
            if [[ "$TAG" == *"-pre"* ]] || [[ "$TAG" == *"-alpha"* ]] || [[ "$TAG" == *"-beta"* ]] || [[ "$TAG" == *"-rc"* ]]; then
              echo "pre_release=true" >> $GITHUB_OUTPUT
            else
              echo "pre_release=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "pre_release=${{ inputs.pre_release }}" >> $GITHUB_OUTPUT
          fi

  package:
    if: ${{ needs.determine-templates.outputs.component == 'templates' }}
    runs-on: ubuntu-latest
    needs: [build-sdk, determine-templates]
    strategy:
      matrix:
        template: ${{ fromJson(needs.determine-templates.outputs.templates) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Download SDK dist
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist

      - run: pnpm install

      - name: Get package info
        id: pkg
        run: |
          cd templates/${{ matrix.template }}
          NAME=$(node -p "require('./package.json').name")
          VERSION=$(node -p "require('./package.json').version")
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Package VSIX
        run: |
          cd templates/${{ matrix.template }}
          PRE_RELEASE_FLAG=""
          if [[ "${{ needs.determine-templates.outputs.pre_release }}" == "true" ]]; then
            PRE_RELEASE_FLAG="--pre-release"
            echo "Packaging as pre-release..."
          fi
          npx @vscode/vsce package --no-dependencies $PRE_RELEASE_FLAG -o ${{ steps.pkg.outputs.name }}-${{ steps.pkg.outputs.version }}.vsix

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.template }}-vsix
          path: templates/${{ matrix.template }}/*.vsix

  publish:
    if: ${{ needs.determine-templates.outputs.component == 'templates' }}
    runs-on: ubuntu-latest
    needs: [package, determine-templates]
    strategy:
      matrix:
        template: ${{ fromJson(needs.determine-templates.outputs.templates) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download VSIX
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.template }}-vsix
          path: ./vsix

      - name: Get VSIX filename
        id: vsix
        run: |
          VSIX_FILE=$(ls ./vsix/*.vsix | head -n 1)
          echo "file=$VSIX_FILE" >> $GITHUB_OUTPUT
          echo "Found VSIX: $VSIX_FILE"

      - name: Publish to VS Code Marketplace
        run: |
          if [[ "${{ needs.determine-templates.outputs.pre_release }}" == "true" ]]; then
            echo "Publishing as pre-release..."
            npx @vscode/vsce publish --pat ${{ secrets.VSCE_PAT }} --packagePath ${{ steps.vsix.outputs.file }} --pre-release
          else
            echo "Publishing as stable release..."
            npx @vscode/vsce publish --pat ${{ secrets.VSCE_PAT }} --packagePath ${{ steps.vsix.outputs.file }}
          fi
        continue-on-error: true

      - name: Publish to Open VSX Registry
        if: ${{ vars.PUBLISH_OVSX == 'true' }}
        run: |
          if [[ "${{ needs.determine-templates.outputs.pre_release }}" == "true" ]]; then
            npx ovsx publish ${{ steps.vsix.outputs.file }} -p ${{ secrets.OVSX_PAT }} --pre-release
          else
            npx ovsx publish ${{ steps.vsix.outputs.file }} -p ${{ secrets.OVSX_PAT }}
          fi
        continue-on-error: true

  package-sdk:
    if: ${{ needs.determine-templates.outputs.component == 'sdk' }}
    runs-on: ubuntu-latest
    needs: [build-sdk, determine-templates]
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - run: pnpm install

      - name: Download SDK dist
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist

      - name: Pack SDK tarball
        id: sdk
        run: |
          mkdir -p artifacts
          cd packages/sdk
          npm pack --pack-destination ../../artifacts
          FILE=$(ls ../../artifacts/*.tgz | head -n 1)
          BASENAME=$(basename "$FILE")
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "name=$BASENAME" >> $GITHUB_OUTPUT

      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdk-package
          path: ${{ steps.sdk.outputs.file }}

  create-release-templates:
    runs-on: ubuntu-latest
    needs: [publish, determine-templates]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && needs.determine-templates.outputs.component == 'templates'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: "*-vsix"
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./artifacts/*.vsix
          name: ${{ github.ref_name }}
          prerelease: ${{ needs.determine-templates.outputs.pre_release == 'true' }}
          generate_release_notes: true
          body: |
            ## üì¶ VS Code Extensions

            Download the VSIX files below and install them in VS Code:
            1. Open VS Code
            2. Press `Ctrl+Shift+P` (or `Cmd+Shift+P` on macOS)
            3. Type "Install from VSIX" and select the downloaded file

            Or install from the [VS Code Marketplace](https://marketplace.visualstudio.com/).

            ${{ needs.determine-templates.outputs.pre_release == 'true' && '‚ö†Ô∏è **This is a pre-release version.** It may contain experimental features.' || '' }}

  create-release-sdk:
    runs-on: ubuntu-latest
    needs: [package-sdk, determine-templates]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && needs.determine-templates.outputs.component == 'sdk'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download SDK package artifact
        uses: actions/download-artifact@v4
        with:
          name: sdk-package
          path: ./artifacts

      - name: Create SDK GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./artifacts/*.tgz
          name: ${{ github.ref_name }}
          prerelease: ${{ needs.determine-templates.outputs.pre_release == 'true' }}
          generate_release_notes: true
          body: |
            ## üì¶ SDK Package

            This release contains the packaged SDK tarball (`.tgz`) for:
            - `@all-in-copilot/sdk`

            Install locally:
            ```bash
            npm i ./all-in-copilot-sdk-*.tgz
            ```

            ${{ needs.determine-templates.outputs.pre_release == 'true' && '‚ö†Ô∏è **This is a pre-release version.** It may contain experimental changes.' || '' }}
