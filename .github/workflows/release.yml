name: Release Extensions

on:
  workflow_dispatch:
    inputs:
      template:
        description: 'Template to release (or "all" for all templates)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - glm-template
          - minimax-template
          - kimi-template
          - mimo-template
      pre_release:
        description: 'Pre-release version'
        required: false
        default: false
        type: boolean
  push:
    tags:
      - 'v*'
      - '*-v*'

env:
  TEMPLATES: glm-template minimax-template kimi-template mimo-template

jobs:
  build-sdk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - run: pnpm install
      - run: pnpm --filter @all-in-copilot/sdk build

      - name: Upload SDK dist
        uses: actions/upload-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist

  determine-templates:
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.set-templates.outputs.templates }}
      pre_release: ${{ steps.set-release-type.outputs.pre_release }}
    steps:
      - name: Determine templates to build
        id: set-templates
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Tag-based release
            TAG="${{ github.ref_name }}"
            if [[ "$TAG" == v* ]]; then
              # Global tag like v1.0.0 - build all
              echo 'templates=["glm-template","minimax-template","kimi-template","mimo-template"]' >> $GITHUB_OUTPUT
            else
              # Template-specific tag like glm-template-v0.1.0
              TEMPLATE="${TAG%-v*}"
              echo "templates=[\"$TEMPLATE\"]" >> $GITHUB_OUTPUT
            fi
          else
            # Manual dispatch
            if [[ "${{ inputs.template }}" == "all" ]]; then
              echo 'templates=["glm-template","minimax-template","kimi-template","mimo-template"]' >> $GITHUB_OUTPUT
            else
              echo "templates=[\"${{ inputs.template }}\"]" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Determine release type
        id: set-release-type
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG="${{ github.ref_name }}"
            if [[ "$TAG" == *"-pre"* ]] || [[ "$TAG" == *"-alpha"* ]] || [[ "$TAG" == *"-beta"* ]] || [[ "$TAG" == *"-rc"* ]]; then
              echo "pre_release=true" >> $GITHUB_OUTPUT
            else
              echo "pre_release=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "pre_release=${{ inputs.pre_release }}" >> $GITHUB_OUTPUT
          fi

  package:
    runs-on: ubuntu-latest
    needs: [build-sdk, determine-templates]
    strategy:
      matrix:
        template: ${{ fromJson(needs.determine-templates.outputs.templates) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Download SDK dist
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist

      - run: pnpm install

      - name: Get package info
        id: pkg
        run: |
          cd templates/${{ matrix.template }}
          NAME=$(node -p "require('./package.json').name")
          VERSION=$(node -p "require('./package.json').version")
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Package VSIX
        run: |
          cd templates/${{ matrix.template }}
          PRE_RELEASE_FLAG=""
          if [[ "${{ needs.determine-templates.outputs.pre_release }}" == "true" ]]; then
            PRE_RELEASE_FLAG="--pre-release"
            echo "Packaging as pre-release..."
          fi
          npx @vscode/vsce package --no-dependencies $PRE_RELEASE_FLAG -o ${{ steps.pkg.outputs.name }}-${{ steps.pkg.outputs.version }}.vsix

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.template }}-vsix
          path: templates/${{ matrix.template }}/*.vsix

  publish:
    runs-on: ubuntu-latest
    needs: [package, determine-templates]
    strategy:
      matrix:
        template: ${{ fromJson(needs.determine-templates.outputs.templates) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download VSIX
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.template }}-vsix
          path: ./vsix

      - name: Get VSIX filename
        id: vsix
        run: |
          VSIX_FILE=$(ls ./vsix/*.vsix | head -n 1)
          echo "file=$VSIX_FILE" >> $GITHUB_OUTPUT
          echo "Found VSIX: $VSIX_FILE"

      - name: Publish to VS Code Marketplace
        run: |
          if [[ "${{ needs.determine-templates.outputs.pre_release }}" == "true" ]]; then
            echo "Publishing as pre-release..."
            npx @vscode/vsce publish --pat ${{ secrets.VSCE_PAT }} --packagePath ${{ steps.vsix.outputs.file }} --pre-release
          else
            echo "Publishing as stable release..."
            npx @vscode/vsce publish --pat ${{ secrets.VSCE_PAT }} --packagePath ${{ steps.vsix.outputs.file }}
          fi
        continue-on-error: true

      - name: Publish to Open VSX Registry
        if: ${{ vars.PUBLISH_OVSX == 'true' }}
        run: |
          if [[ "${{ needs.determine-templates.outputs.pre_release }}" == "true" ]]; then
            npx ovsx publish ${{ steps.vsix.outputs.file }} -p ${{ secrets.OVSX_PAT }} --pre-release
          else
            npx ovsx publish ${{ steps.vsix.outputs.file }} -p ${{ secrets.OVSX_PAT }}
          fi
        continue-on-error: true

  create-release:
    runs-on: ubuntu-latest
    needs: [publish, determine-templates]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: '*-vsix'
          merge-multiple: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./artifacts/*.vsix
          prerelease: ${{ needs.determine-templates.outputs.pre_release == 'true' }}
          generate_release_notes: true
          body: |
            ## üì¶ VS Code Extensions

            Download the VSIX files below and install them in VS Code:
            1. Open VS Code
            2. Press `Ctrl+Shift+P` (or `Cmd+Shift+P` on macOS)
            3. Type "Install from VSIX" and select the downloaded file

            Or install from the [VS Code Marketplace](https://marketplace.visualstudio.com/).

            ${{ needs.determine-templates.outputs.pre_release == 'true' && '‚ö†Ô∏è **This is a pre-release version.** It may contain experimental features.' || '' }}
